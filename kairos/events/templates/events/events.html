{% extends 'layout.html' %}

{% block title %}
    Events
{% endblock %}


{% block content %}
    <div x-data="eventsComponent()" class="container mx-auto max-w-[1200px] px-8">

        <form action="{% url 'events:list' %}" method="GET" class="max-h-fit flex my-16 space-x-4 md:flex-row flex-col gap-y-4 md:gap-0">
          {% csrf_token %}
          {{ form }}
          <input value="{{request.GET.search}}" @keydown.enter="loadEvents();" class=" rounded-lg w-full md:w-2/3" id="search" name="search" type="text" placeholder="Search Event"  />

          <!-- Dropdown Menu -->
          <select value="{{request.GET.sort}}" onchange="this.form.submit()" name="sort" id="sort" class="bg-secondary text-white z-10 p-3 rounded-md transition-colors duration-300 hover:border-secondary border-2 border-light cursor-pointer">
              <option value="alphabetical-increasing" {% if request.GET.sort == "alphabetical-increasing"%}selected{% endif %}>Alphabetical Increasing</option>
              <option value="alphabetical-decreasing" {% if request.GET.sort == "alphabetical-decreasing"%}selected{% endif %}>Alphabetical Decreasing</option>

              <option value="most-recent" {% if request.GET.sort == "most-recent"%}selected{% endif %}>Most Recent</option>
              <option value="least-recent" {% if request.GET.sort == "least-recent"%}selected{% endif %}>Least Recent</option>
          </select>
        </form>
        
        <div class="max-h-[50vh] overflow-y-scroll space-y-8 pr-4">
          {% if events %}
            {% for event in events %}
              <div class="w-full h-32 bg-white p-4 rounded-lg border-2 border-dark shadow">
                <h3 class="font-bold text-lg text-gray-800">{{ event.title }}</h3>
                <p class="text-gray-600">{{ event.body }}</p>
                <p class="text-xs text-gray-400 italic">{{ event.slug }}</p>
                <p class="text-sm text-gray-500 mt-1">{{ event.date }}</p>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-gray-500 text-center py-4">
              No events found. Create one in the admin panel.
            </div>
          {% endif %}
        </div>
    </div>

    {% comment %} <script>
      const eventsComponent = () => ({
        has_unread: false,
        open: false,
        notifications: [],

        async loadEvents() {
          console.log("Inside load events!");
          

          const res = await fetch('/events/', {method: 'GET', headers: {'X-CSRFToken': csrfToken} });
          if (res.ok) {
              const data = await res.json();
              console.log("Events recieved", data);
              this.event = data;
          } else {
              console.error('failed to load notifications');
          }
        }
      });
    </script> {% endcomment %}
    
    </div>

{% endblock %}


{% comment %} <script>
    document.addEventListener("alpine:init", () => {
      Alpine.data("eventsPage", () => ({
        events: [],
        async init() {
          const token = localStorage.getItem("access");
  
          if (!token) {
            window.location.href = "/login/";
            return;
          }
  
          try {
            const res = await fetch("/api/events/", {
              headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
              }
            });
  
            if (res.status === 401) {
              window.location.href = "/login/";
              return;
            }
  
            const data = await res.json();
            this.events = data; 
          } catch (err) {
            console.error("Error loading events:", err);
          }
        }
      }))
    });
  </script> {% endcomment %}